@startuml
title Statemachine Broker

state send {
[*] --> Queue
Queue --> SPIrequest : start timer
SPIrequest --> [*]
}
state poll {
[*]  --> SPIdummy
SPIdummy --> SPIread
SPIread --> FailedSend : SPI timeout
SPIread --> CheckQueue : message
CheckQueue : search message in queue
CheckQueue --> SPIresponse : message found in queue
SPIresponse --> SPIdummy : message not found
SPIresponse : send evResponse

FailedSend --> SPIdummy : (retry > 0)
FailedSend --> [*] : (retry = 0)
FailedSend: #Retry?
}


state timer_alert {
[*] --> CheckQueueTimeout
CheckQueueTimeout --> Timeout : message found
Timeout -> [*]
CheckQueueTimeout --> [*] : message not found
Timeout : send evTimeout
Timeout : delete item from queue
}

[*] -> idle
idle -> send : evRequest()
send -> poll 
poll -up-> idle : Queue empty




@enduml
